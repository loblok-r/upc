name: Deploy Backend (Git Pull Mode)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_USER: root

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. åŒæ­¥åˆ° Gitee
      - name: Sync to Gitee (SSH)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.GITEE_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H gitee.com >> ~/.ssh/known_hosts
          git remote add gitee git@gitee.com:barondd/upc.git
          echo "Pushing to Gitee..."
          git push gitee HEAD:main -f

      # 3. æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²
      - name: Execute Server Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_IP }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script_stop: true
          script: |
            set -e
            PROJECT_DIR="/opt/projects/upc-backend"
            GITEE_URL="https://gitee.com/barondd/upc.git"
            
            # --- 1. ä»£ç æ‹‰å–ä¸å‡†å¤‡ ---
            if [ -d "$PROJECT_DIR" ] && [ ! -d "$PROJECT_DIR/.git" ]; then
              rm -rf "$PROJECT_PATH"
            fi
            if [ ! -d "$PROJECT_DIR" ]; then
              git clone "$GITEE_URL" "$PROJECT_DIR"
            fi
            
            cd "$PROJECT_DIR"
            echo "Discarding all local changes..."
            git reset --hard HEAD
            git clean -fd -e .env -e mysql/ -e redis/ -e config/
            
            echo "ğŸ”§ Fetching latest code..."
            git remote set-url origin "$GITEE_URL" || git remote add origin "$GITEE_URL"
            git fetch origin
            git checkout -q "${{ github.sha }}"
            
            # --- 2. æ„å»ºé•œåƒ ---
            echo "Packaging jar..."
            mvn clean package -DskipTests
            
            echo "Building Docker image..."
            DOCKER_BUILDKIT=0 docker build -t upc-backend:latest .
            
            # --- 3. é˜¶æ¢¯å¼å¯åŠ¨ (è§£å†³ç½‘ç»œè§£æé—®é¢˜) ---
            echo "Cleaning old containers and network..."
            # åœæ­¢å½“å‰æœåŠ¡å¹¶æ¸…ç†å­¤å„¿å®¹å™¨ (å¦‚ nacos)
            docker compose down --remove-orphans
            # å¼ºåˆ¶æ¸…ç†ç½‘ç»œæ®‹ç•™ï¼Œç¡®ä¿ DNS ç¼“å­˜åˆ·æ–°
            docker network prune -f
            
            echo "åŸºç¡€ç»„ä»¶å¯åŠ¨ä¸­ (MySQL/Redis)..."
            docker compose up -d mysql redis
            
            # å…³é”®ï¼šç»™ Redis 15ç§’æ—¶é—´å®Œæˆå¯åŠ¨å¹¶åœ¨ Docker DNS ä¸­æ³¨å†Œ
            echo "Waiting 15s for Redis DNS to stabilize..."
            sleep 15
            
            echo "Launching Backend instances (Rolling update)..."
            # ä½¿ç”¨ --no-deps ç¡®ä¿ä¸å†åŠ¨å·²ç»èµ·å¥½çš„åŸºç¡€ç»„ä»¶
            docker compose up -d --no-deps --force-recreate backend
            
            echo "Launching Frontend..."
            docker compose up -d --no-deps --force-recreate frontend
            
            # --- 4. æ¸…ç† ---
            echo "Cleaning up..."
            docker image prune -f
            echo "Deployment completed!"