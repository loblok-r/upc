services:
  # --- 基础存储组件 ---
  mysql:
    image: mysql:8.0
    container_name: upc-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: upc
      TZ: Asia/Shanghai
    ports:
      - "127.0.0.1:3306:3306" # 仅限本地访问，安全考虑
    command:
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
      --default-authentication-plugin=mysql_native_password
      --innodb-buffer-pool-size=512M
    volumes:
      - /opt/projects/upc-backend/mysql/data:/var/lib/mysql
      - /opt/projects/upc-backend/mysql/conf:/etc/mysql/conf.d
      - /opt/projects/upc-backend/mysql/init:/docker-entrypoint-initdb.d
    deploy:
      resources:
        limits:
          memory: 512M

  redis:
    image: redis:6.2
    container_name: upc-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - /opt/projects/upc-backend/redis/data:/data
    deploy:
      resources:
        limits:
          memory: 256M

  # --- 微服务基础设施 ---
  rabbitmq:
    image: rabbitmq:3-management
    container_name: upc-mq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    deploy:
      resources:
        limits:
          memory: 400M

  consul:
    image: hashicorp/consul:1.15
    container_name: upc-consul
    command: "agent -dev -client 0.0.0.0"
    ports:
      - "8500:8500"
    deploy:
      resources:
        limits:
          memory: 128M

  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: upc-meili
    restart: always
    environment:
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}
      MEILI_NO_ANALYTICS: "true"
      MEILI_ENV: "production"
    volumes:
      - /opt/projects/upc-backend/meili_data:/data
    deploy:
      resources:
        limits:
          memory: 256M

  # --- 业务模块 ---
  upc-trade:
    build:
      context: ./upc-trade  # 这里指定相对于 docker-compose 文件的子模块目录
      dockerfile: Dockerfile
    ports:
      - "8084:8084"
    image: upc-trade:latest
    container_name: upc-trade
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: pro

      JAVA_OPTS: "-Xms320m -Xmx320m"
      SPRING_CLOUD_CONSUL_HOST: upc-consul
      SPRING_CLOUD_CONSUL_PORT: 8500
      SPRING_CLOUD_CLIENT_IP_ADDRESS: ${TXY_PUBLIC_IP}
      SPRING_CLOUD_CONSUL_DISCOVERY_PREFER_IP_ADDRESS: "true"

      SPRING_DATASOURCE_URL: "jdbc:mysql://upc-mysql:3306/upc?useSSL=false"
      SPRING_DATA_REDIS_HOST: upc-redis

      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JASYPT_ENCRYPTOR_PASSWORD: ${JASYPT_PASSWORD}

      # RabbitMQ 配置
      SPRING_RABBITMQ_HOST: upc-mq
      SPRING_RABBITMQ_PORT: 5672
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}

      SPRING_CONFIG_IMPORT: "optional:file:/config/application-pro.yml"
    volumes:
      - ./config/upc-trade-pro.yml:/config/application-pro.yml
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      mysql:
        condition: service_started
      redis:
        condition: service_started
      consul:
        condition: service_started
      rabbitmq:
        condition: service_started

  upc-community:
    build:
      context: ./upc-community  # 这里指定相对于 docker-compose 文件的子模块目录
      dockerfile: Dockerfile
    ports:
      - "8083:8083"
    image: upc-community:latest
    container_name: upc-community
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: pro
      SPRING_CLOUD_CLIENT_IP_ADDRESS: ${TXY_PUBLIC_IP}
      # 1. 基础 JVM 与 注册中心配置
      JAVA_OPTS: "-Xms320m -Xmx320m"
      SPRING_CLOUD_CONSUL_HOST: upc-consul
      SPRING_CLOUD_CONSUL_PORT: 8500
      SPRING_CLOUD_CONSUL_DISCOVERY_PREFER_IP_ADDRESS: "true"


      SPRING_DATASOURCE_URL: "jdbc:mysql://upc-mysql:3306/upc?useSSL=false"
      SPRING_DATA_REDIS_HOST: upc-redis
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      MEILI_URL: "http://upc-meili:7700"
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}
      UPC_STORAGE_TYPE: cos
      JASYPT_ENCRYPTOR_PASSWORD: ${JASYPT_PASSWORD}

      # RabbitMQ 配置
      SPRING_RABBITMQ_HOST: upc-mq
      SPRING_RABBITMQ_PORT: 5672
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}

      SPRING_CONFIG_IMPORT: "optional:file:/config/application-pro.yml"
    volumes:
      - ./config/upc-community-pro.yml:/config/application-pro.yml
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      mysql:
        condition: service_started
      redis:
        condition: service_started
      consul:
        condition: service_started
      meilisearch:
        condition: service_started
      rabbitmq:
        condition: service_started

  # --- 用户与会员模块 ---
  upc-auth-user:
    build:
      context: ./upc-auth-user
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
    image: upc-auth-user:latest
    container_name: upc-auth-user
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: pro
      SPRING_CLOUD_CLIENT_IP_ADDRESS: ${TXY_PUBLIC_IP}
      # 1. 基础 JVM 与 注册中心配置
      JAVA_OPTS: "-Xms320m -Xmx320m"
      SPRING_CLOUD_CONSUL_HOST: upc-consul
      SPRING_CLOUD_CONSUL_PORT: 8500
      SPRING_CLOUD_CONSUL_DISCOVERY_PREFER_IP_ADDRESS: "true"

      SPRING_DATASOURCE_URL: "jdbc:mysql://upc-mysql:3306/upc?useSSL=false"
      SPRING_DATA_REDIS_HOST: upc-redis
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      JASYPT_ENCRYPTOR_PASSWORD: ${JASYPT_PASSWORD}
      # RabbitMQ 配置
      SPRING_RABBITMQ_HOST: upc-mq
      SPRING_RABBITMQ_PORT: 5672
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
      SPRING_CONFIG_IMPORT: "optional:file:/config/application-pro.yml"
    volumes:
      - ./config/upc-auth-user-pro.yml:/config/application-pro.yml
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      redis:
        condition: service_started
      consul:
        condition: service_started
      rabbitmq:
        condition: service_started

  # --- 消息处理模块 (Worker) ---
  upc-worker:
    build:
      context: ./upc-worker
      dockerfile: Dockerfile
    ports:
      - "8085:8085"
    image: upc-worker:latest
    container_name: upc-worker
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: pro
      SPRING_CLOUD_CLIENT_IP_ADDRESS: ${TXY_PUBLIC_IP}
      # 1. 基础 JVM 与 注册中心配置
      JAVA_OPTS: "-Xms320m -Xmx320m"
      SPRING_CLOUD_CONSUL_HOST: upc-consul
      SPRING_CLOUD_CONSUL_PORT: 8500
      SPRING_CLOUD_CONSUL_DISCOVERY_PREFER_IP_ADDRESS: "true"

      JASYPT_ENCRYPTOR_PASSWORD: ${JASYPT_PASSWORD}
      SPRING_DATASOURCE_URL: "jdbc:mysql://upc-mysql:3306/upc?useSSL=false"
      SPRING_DATA_REDIS_HOST: upc-redis
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      MAIL_PASSWORD: ${MAIL_PASSWORD}

      MEILI_URL: "http://upc-meili:7700"
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}

      # RabbitMQ 配置
      SPRING_RABBITMQ_HOST: upc-mq
      SPRING_RABBITMQ_PORT: 5672
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
      SPRING_CONFIG_IMPORT: "optional:file:/config/application-pro.yml"
    volumes:
      - ./config/upc-worker-pro.yml:/config/application-pro.yml
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      redis:
        condition: service_started
      consul:
        condition: service_started
      rabbitmq:
        condition: service_started

networks:
  default:
    name: upc-net
    driver: bridge