name: Deploy Backend (Git Pull Mode)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_USER: root

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ä¸ºäº†è§¦å‘ Actionï¼Œå®žé™…ä¸Šä¸éœ€è¦åœ¨ GitHub çŽ¯å¢ƒåšä»»ä½•äº‹
      # åªéœ€è¦é€šè¿‡ SSH å‘½ä»¤æŒ‡æŒ¥æœåŠ¡å™¨å¹²æ´»

      - name: Execute Server Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_IP }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script_stop: true
          script: |
            set -e
  
            PROJECT_DIR="/opt/projects/upc-backend"
            GITEE_URL="https://gitee.com/barondd/upc.git"
            
            # å¦‚æžœç›®å½•å­˜åœ¨ä½†ä¸æ˜¯ Git ä»“åº“ï¼Œæ¸…ç†
            if [ -d "$PROJECT_DIR" ] && [ ! -d "$PROJECT_DIR/.git" ]; then
              echo "Removing non-Git directory: $PROJECT_DIR"
              rm -rf "$PROJECT_DIR"
            fi
            
            # å¦‚æžœç›®å½•ä¸å­˜åœ¨ï¼Œå…‹éš† Gitee
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "Cloning from Gitee..."
              git clone "$GITEE_URL" "$PROJECT_DIR"
            fi
            
            cd "$PROJECT_DIR"
            
            # æ¸…ç†æœ¬åœ°æ‰€æœ‰ä¿®æ”¹
            echo "Discarding all local changes..."
            git reset --hard HEAD
            git clean -fd
            
            # å¼ºåˆ¶è®¾ç½® remote origin ä¸º Giteeï¼
            echo "ðŸ”§ Ensuring remote origin points to Gitee..."
            git remote set-url origin "$GITEE_URL" || git remote add origin "$GITEE_URL"
            
            git fetch origin
            
            # ç²¾å‡†æ£€å‡º GitHub è§¦å‘æœ¬æ¬¡ Action çš„ commit
            COMMIT_SHA="${{ github.sha }}"
            echo "ðŸ” Checking out commit: $COMMIT_SHA"
            git checkout -q "$COMMIT_SHA"
            
          
            mvn clean package -DskipTests
            docker build -t upc-backend:latest .
            sed -i "s|^DOCKER_IMAGE_NAME=.*|DOCKER_IMAGE_NAME=upc-backend:latest|" .env
            docker compose down backend 2>/dev/null || true
            docker compose up -d --force-recreate backend
            docker image prune -f