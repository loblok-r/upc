name: Deploy Backend (Git Pull Mode)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_USER: root

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç  (å¿…é¡»è®¾ç½® fetch-depth: 0 ä»¥ä¿è¯æœ‰å®Œæ•´æäº¤å†å²ç”¨äºæ¨é€)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘é…ç½® SSH å¹¶æ¨é€åˆ° Gitee
      - name: Sync to Gitee (SSH)
        env:
          # å¼•ç”¨ä½ åœ¨ GitHub è®¾ç½®çš„ Secret
          SSH_PRIVATE_KEY: ${{ secrets.GITEE_PRIVATE_KEY }}
        run: |
          # A. é…ç½® SSH ç›®å½•å’Œç§é’¥æ–‡ä»¶
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # B. å°† Gitee åŠ å…¥å·²çŸ¥ä¸»æœºåˆ—è¡¨ (é˜²æ­¢å› ä¸ºæŒ‡çº¹éªŒè¯å¤±è´¥è€ŒæŠ¥é”™)
          ssh-keyscan -H gitee.com >> ~/.ssh/known_hosts
          
          # C. é…ç½® Git æ¨é€
          # æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»ç”¨ SSH æ ¼å¼çš„åœ°å€ (git@gitee.com:...)
          # è¯·ç¡®è®¤ä½ çš„ç”¨æˆ·åå’Œä»“åº“åæ˜¯å¦æ­£ç¡®
          git remote add gitee git@gitee.com:barondd/upc.git
          
          # D. å¼ºè¡Œæ¨é€
          echo "ğŸš€ Pushing to Gitee..."
          git push gitee HEAD:main -f
          
          # 3. æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²
          - name: Execute Server Commands
            uses: appleboy/ssh-action@v1.0.3
            with:
              host: ${{ env.SERVER_IP }}
              username: ${{ env.SERVER_USER }}
              password: ${{ secrets.SERVER_PASSWORD }}
              script_stop: true
              # ã€å…³é”®ä¿®æ”¹ 1ã€‘é€šè¿‡ envs ä¼ é€’å˜é‡
              envs: GITHUB_SHA
              script: |
                set -e
                PROJECT_DIR="/opt/projects/upc-backend"
                GITEE_URL="https://gitee.com/barondd/upc.git"
          
                if [ -d "$PROJECT_DIR" ] && [ ! -d "$PROJECT_DIR/.git" ]; then
                  rm -rf "$PROJECT_DIR"
                fi
          
                if [ ! -d "$PROJECT_DIR" ]; then
                  git clone "$GITEE_URL" "$PROJECT_DIR"
                fi
          
                cd "$PROJECT_DIR"
          
                echo "Discarding all local changes..."
                git reset --hard HEAD
                git clean -fd -e .env -e mysql/ -e redis/ -e config/
          
                echo "ğŸ”§ Ensuring remote origin points to Gitee..."
                git remote set-url origin "$GITEE_URL" || git remote add origin "$GITEE_URL"
          
                git fetch origin
          
                # ã€å…³é”®ä¿®æ”¹ 2ã€‘ç›´æ¥ä½¿ç”¨å˜é‡åï¼Œä¸å†éœ€è¦ ${{ }}
                echo "ğŸ” Checking out commit: $GITHUB_SHA"
                git checkout -q "$GITHUB_SHA"
          
                mvn clean package -DskipTests
          
                echo "ğŸ³ Building Docker image..."
                DOCKER_BUILDKIT=0 docker build -t upc-backend:latest .
          
                sed -i "s|^DOCKER_IMAGE_NAME=.*|DOCKER_IMAGE_NAME=upc-backend:latest|" .env
                docker compose down backend 2>/dev/null || true
                docker compose up -d --force-recreate backend
                docker image prune -f
            env:
              # ã€å…³é”®ä¿®æ”¹ 3ã€‘åœ¨è¿™é‡Œå®šä¹‰è¦ä¼ é€’ç»™ action çš„ç¯å¢ƒå˜é‡
              GITHUB_SHA: ${{ github.sha }}