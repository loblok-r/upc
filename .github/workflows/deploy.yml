name: Deploy Backend (Git Pull Mode)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_USER: root

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. è¿™ä¸€æ­¥åªä¸ºäº†è§¦å‘ Actionï¼Œå®žé™…ä¸Šæˆ‘ä»¬ä¸éœ€è¦åœ¨ GitHub çŽ¯å¢ƒåšä»»ä½•äº‹
      # æˆ‘ä»¬åªéœ€è¦é€šè¿‡ SSH å‘½ä»¤æŒ‡æŒ¥æœåŠ¡å™¨å¹²æ´»

      - name: Execute Server Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_IP }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script_stop: true
          script: |
            set -e

            PROJECT_DIR="/opt/projects/upc-backend"

            # å¦‚æžœç›®å½•å­˜åœ¨ä½†ä¸æ˜¯ Git ä»“åº“ï¼Œå°±åˆ æŽ‰å®ƒï¼ˆé¿å… git clone å¤±è´¥ï¼‰
            if [ -d "$PROJECT_DIR" ] && [ ! -d "$PROJECT_DIR/.git" ]; then
              echo "âš ï¸ $PROJECT_DIR exists but is not a Git repo. Removing it..."
              rm -rf "$PROJECT_DIR"
            fi

            # å¦‚æžœç›®å½•ä¸å­˜åœ¨ï¼Œå°±å…‹éš†
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ðŸ”„ Cloning repository..."
              git clone https://github.com/loblok-r/upc.git "$PROJECT_DIR"
            fi

            cd "$PROJECT_DIR"
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main

            # åŽç»­æ­¥éª¤...
            mvn clean package -DskipTests
            docker build -t upc-backend:latest .
            sed -i "s|^DOCKER_IMAGE_NAME=.*|DOCKER_IMAGE_NAME=upc-backend:latest|" .env
            docker compose down backend 2>/dev/null || true
            docker compose up -d --force-recreate backend
            docker image prune -f