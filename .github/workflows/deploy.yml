- name: Execute Server Commands
  uses: appleboy/ssh-action@master
  with:
    host: ${{ env.SERVER_IP }}
    username: ${{ env.SERVER_USER }}
    password: ${{ secrets.SERVER_PASSWORD }}
    script_stop: true  # ðŸ‘ˆ å…³é”®ï¼SSH è„šæœ¬å‡ºé”™å°±è®© Action å¤±è´¥
    script: |
      set -e  # ðŸ‘ˆ å…³é”®ï¼ä»»ä½•å‘½ä»¤å¤±è´¥ç«‹å³é€€å‡º
      
      PROJECT_DIR="/opt/projects/upc-backend"
      
      if [ ! -d "$PROJECT_DIR/.git" ]; then
        echo "ðŸ”„ Cloning repository for the first time..."
        rm -rf "$PROJECT_DIR"
        git clone https://github.com/loblok-r/upc.git "$PROJECT_DIR"
      fi
      
      cd "$PROJECT_DIR"
      echo "ðŸ“¥ Pulling latest code..."
      git pull origin main
      
      echo "ðŸ§± Building JAR (skipping tests)..."
      mvn clean package -DskipTests
      
      echo "ðŸ“¦ Building Docker image..."
      docker build -t upc-backend:latest .
      
      echo "ðŸ”§ Updating .env to use local image..."
      sed -i "s|^DOCKER_IMAGE_NAME=.*|DOCKER_IMAGE_NAME=upc-backend:latest|" .env
      
      echo "ðŸš€ Restarting backend service..."
      docker compose down backend 2>/dev/null || true
      docker compose up -d --force-recreate backend
      
      echo "âœ… Deployment completed!"
      docker compose ps