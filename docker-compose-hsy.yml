services:
  # --- 流量入口 (Nginx) ---
  frontend:
    image: upc-frontend:latest
    container_name: upc-frontend
    restart: always
    ports:
      - "80:80"
    # 建议挂载 nginx 配置，将 /api 转发给本地网关 8069
    # volumes:
    #   - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    deploy:
      resources:
        limits:
          memory: 64M # Nginx 占用极低，64M 足够

  # --- 网关模块 ---
  upc-gateway:
    build:
      context: ./upc-gateway
      dockerfile: Dockerfile
    image: upc-gateway:latest
    container_name: upc-gateway
    restart: always
    ports:
      - "8069:8069"
    environment:
      SPRING_PROFILES_ACTIVE: pro
      # JVM 内存优化：网关是非阻塞的，128M 够用
      JAVA_OPTS: "-Xms128m -Xmx128m -XX:MaxMetaspaceSize=128m"

      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN}

      # 注册中心：指向腾讯云 TXY
      SPRING_CLOUD_CONSUL_HOST: ${TXY_PUBLIC_IP}
      SPRING_CLOUD_CONSUL_PORT: 8500

      # 跨云通信核心配置：必须注册 HSY 的公网 IP 供前端和 Consul 识别
      SPRING_CLOUD_CONSUL_DISCOVERY_PREFER_IP_ADDRESS: "true"
      SPRING_CLOUD_CONSUL_DISCOVERY_IP_ADDRESS: ${HSY_PUBLIC_IP}

      JASYPT_ENCRYPTOR_PASSWORD: ${JASYPT_PASSWORD}

      # Redis 连接配置
      SPRING_DATA_REDIS_HOST: ${TXY_PUBLIC_IP}
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}

      # 外部配置
      SPRING_CONFIG_IMPORT: "optional:file:/config/application-pro.yml"
    volumes:
      - ./config/upc-gateway-pro.yml:/config/application-pro.yml
    deploy:
      resources:
        limits:
          memory: 256M

  # --- AI 模块 ---
  upc-ai:
    ports:
      - "8082:8082"
    build:
      context: ./upc-ai
    image: upc-ai:latest
    container_name: upc-ai
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: pro
      JAVA_OPTS: "-Xms320m -Xmx320m -XX:MaxMetaspaceSize=128m"

      # 注册中心
      SPRING_CLOUD_CONSUL_HOST: ${TXY_PUBLIC_IP}
      SPRING_CLOUD_CONSUL_DISCOVERY_PREFER_IP_ADDRESS: "true"
      SPRING_CLOUD_CONSUL_DISCOVERY_IP_ADDRESS: ${HSY_PUBLIC_IP}

      # 存储与密钥
      TENCENT_COS_SECRET_ID: ${TENCENT_COS_SECRET_ID}
      TENCENT_COS_SECRET_KEY: ${TENCENT_COS_SECRET_KEY}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      QWEN_API_KEY: ${QWEN_API_KEY}
      SILICON_API_KEY: ${SILICON_API_KEY}
      UPC_STORAGE_TYPE: cos
      JASYPT_ENCRYPTOR_PASSWORD: ${JASYPT_PASSWORD}

      # 连接 TXY 的中间件
      # Redis 即使没有显式配置，Spring 默认也会找 localhost，这里建议加上：
      SPRING_DATA_REDIS_HOST: ${TXY_PUBLIC_IP}
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}

      # RabbitMQ
      SPRING_RABBITMQ_HOST: ${TXY_PUBLIC_IP}
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_DEFAULT_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_DEFAULT_PASS}

      SPRING_CONFIG_IMPORT: "optional:file:/config/application-pro.yml"
    volumes:
      - ./config/upc-ai-pro.yml:/config/application-pro.yml
    deploy:
      resources:
        limits:
          memory: 512M

networks:
  default:
    name: upc-net
    driver: bridge